<!doctype html><html lang=zh><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug - 浮枕星海</title><link rel=manifest href=/manifest.json><meta name=theme-color content=#9932CC><meta name=application-name content=浮枕星海><meta name=msapplication-TileImage content=/img/favicon.png><meta name=msapplication-TileColor content=#9932CC><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-title content=浮枕星海><meta name=apple-mobile-web-app-status-bar-style content=default><meta name=description content="闲话少说，如果你在使用基于由 Apple 提供的 Bonjour 协议的服务（例如通过网络刷新 AltStore 应用，iTunes WiFi 同步等）时遇到无法正常连接的问题，并且查看 Windows 事件查看器的 Windows 日志中发现此应用程序错误（异常代码和错误偏移量一致）："><meta property=og:type content=blog><meta property=og:title content="Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug"><meta property=og:url content=https://universesaurora.top/2024/09/29/bonjour_fix/ ><meta property=og:site_name content=浮枕星海><meta property=og:description content="闲话少说，如果你在使用基于由 Apple 提供的 Bonjour 协议的服务（例如通过网络刷新 AltStore 应用，iTunes WiFi 同步等）时遇到无法正常连接的问题，并且查看 Windows 事件查看器的 Windows 日志中发现此应用程序错误（异常代码和错误偏移量一致）："><meta property=og:locale content=zh_CN><meta property=og:image content=https://cdn.pixabay.com/photo/2023/08/08/21/25/france-8178164_1280.jpg><meta property=article:published_time content=2024-09-29T23:15:16.000Z><meta property=article:modified_time content=2024-09-29T23:15:16.000Z><meta property=article:author content=浮枕><meta property=article:tag content=网络><meta property=article:tag content=逆向><meta property=article:tag content=代理><meta property=article:tag content=Bonjour><meta property=twitter:card content=summary><meta property=twitter:image:src content=https://cdn.pixabay.com/photo/2023/08/08/21/25/france-8178164_1280.jpg><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://universesaurora.top/2024/09/29/bonjour_fix/"},"headline":"Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug","image":["https://cdn.pixabay.com/photo/2023/08/08/21/25/france-8178164_1280.jpg"],"datePublished":"2024-09-29T23:15:16.000Z","dateModified":"2024-09-29T23:15:16.000Z","author":{"@type":"Person","name":"浮枕"},"publisher":{"@type":"Organization","name":"浮枕星海","logo":{"@type":"ImageObject","url":"https://universesaurora.top/img/logo.png"}},"description":"闲话少说，如果你在使用基于由 Apple 提供的 Bonjour 协议的服务（例如通过网络刷新 AltStore 应用，iTunes WiFi 同步等）时遇到无法正常连接的问题，并且查看 Windows 事件查看器的 Windows 日志中发现此应用程序错误（异常代码和错误偏移量一致）："}</script><link rel=canonical href=https://universesaurora.top/2024/09/29/bonjour_fix/ ><link rel=alternate href=/atom.xml title=浮枕星海 type=application/atom+xml><link rel=icon href=/img/favicon.png><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/highlight.js/11.7.0/styles/xcode.min.css><link rel=stylesheet href="https://fonts.googlefonts.cn/css2?family=Source+Serif+Pro&amp;family=Roboto+Mono&amp;family=Noto+Serif+SC"><link rel=stylesheet href=/css/default.css><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js defer></script><!--!--><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css><script src="https://www.googletagmanager.com/gtag/js?id=UA-172917863-2" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-172917863-2")</script><!--!--><!--!--><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src=https://cdn.bootcdn.net/ajax/libs/pace/1.2.4/pace.min.js></script><!--!--><!--!--><meta name=follow.it-verification-code content=6w6wNNa9dLg34hkzxXZS><script>!function(){function e(){if(!location.hash)return;const e="#"+CSS.escape(location.hash.substring(1)),t=document.querySelector(`.tabs a[href="${e}"]`);if(!t)return;const n=t.parentElement.parentElement;Array.from(n.children).forEach((e=>e.classList.remove("is-active"))),Array.from(n.querySelectorAll("a")).map((e=>document.getElementById(e.getAttribute("href").substring(1)))).forEach((e=>e.classList.add("is-hidden"))),t&&t.parentElement.classList.add("is-active");const r=document.querySelector(e);r&&r.classList.remove("is-hidden")}e(),window.addEventListener("hashchange",e,!1)}()</script><meta name=generator content="Hexo 6.3.0"><body class=is-3-column><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href=/ ><img src=/img/logo.png alt=浮枕星海 height=28></a></div><div class=navbar-menu><div class=navbar-start><a class=navbar-item href=/ >首页</a><a class=navbar-item href=/archives>归档</a><a class=navbar-item href=/categories>分类</a><a class=navbar-item href=/tags>标签</a><a class=navbar-item href=/links>友链</a><a class=navbar-item href=/about>关于</a></div><div class=navbar-end><a class="navbar-item is-hidden-tablet catalogue" title=目录 href=javascript:;><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title=搜索 href=javascript:;><i class="fas fa-search"></i></a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class=card><div class=card-image><span class="image is-7by3"><img class=fill src=https://cdn.pixabay.com/photo/2023/08/08/21/25/france-8178164_1280.jpg alt="Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug"></span></div><article class="card-content article" role=article><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class=level-left><span class=level-item><time datetime=2024-09-29T23:15:16.000Z title="9/29/2024, 11:15:16 PM">2024-09-30</time>发表</span><span class=level-item><a class=link-muted href=/categories/%E9%80%86%E5%90%91/ >逆向</a></span><span class=level-item>28 分钟读完 (大约4238个字)</span><span class=level-item id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv>0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug</h1><div class=content><p>闲话少说，如果你在使用基于由 Apple 提供的 Bonjour 协议的服务（例如通过网络刷新 AltStore 应用，iTunes WiFi 同步等）时遇到无法正常连接的问题，并且查看 Windows 事件查看器的 Windows 日志中发现此应用程序错误（异常代码和错误偏移量一致）：</p><span id=more></span><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>错误应用程序名称: mDNSResponder.exe，版本: 3.1.0.1，时间戳: 0x55cbcce6</span><br><span class=line>错误模块名称: mDNSResponder.exe，版本: 3.1.0.1，时间戳: 0x55cbcce6</span><br><span class=line>异常代码: 0xc0000409</span><br><span class=line>错误偏移量: 0x00000000000437c3</span><br><span class=line>错误进程 ID: 0x0x9BA8</span><br><span class=line>错误应用程序启动时间: 0x0x1DB1204029AD2A1</span><br><span class=line>错误应用程序路径: C:\Program Files\Bonjour\mDNSResponder.exe</span><br><span class=line>错误模块路径: C:\Program Files\Bonjour\mDNSResponder.exe</span><br><span class=line>报告 ID: 97706ac4-91ee-484e-a851-e12e37433bd0</span><br><span class=line>错误程序包全名: </span><br><span class=line>错误程序包相对应用程序 ID: </span><br></pre></table></figure><p>那么<a target=_blank rel=noopener href="https://1drv.ms/u/s!AiqwR6LDRXHbkytc6emn6FL0zUr3?e=rufbKu">下载这个</a>修复后的 <code>mDNSResponder.exe</code>，替换掉 <code>C:\Program Files\Bonjour\mDNSResponder.exe</code>，然后去服务里重启 Bonjour 服务即可。如果是 AltStore 刷新不了的问题，还需要在这之后重启 Altserver。<h1 id=%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF tabindex=-1>问题背景</h1><p>之前我在 Windows 上用代理软件一般不打开系统代理等设置，只通过 port 访问，然后通过 proxifier 或者手动设置 HTTP 代理（一般是命令行）方式访问代理。然而这种方式会带来一些问题：最主要就是有的软件用 HTTP 连不上用 SOCKS 却可以，或者反过来的情况，这就导致规则很难设置；还有就是有的规则要用全局有点规则要用分流导致要同时开两个代理软件等等。proxifier 有时候又会出现莫名奇妙地无法代理的问题，然后它这个软件原理又比较奇妙很难查明原因（不是用的系统设置中的代理设置，也没有创建网卡，感觉更像是注入），比如我最近代理 VRChat 的时候就有时候能用有时候用不了，查了半天也找不到原因…<p>之所以一直用着是一是因为我希望 Windows 上的软件尽量不走代理，我大部分的代理需求都来自浏览器，已经被 SmartProxy 这类扩展解决了，proxifier主要还是解决 Discord 这类不用代理就连不上的软件，或者 GitHub 这类域名等；二是因为我的系统上还有 Tailscale、Altserver 之类对本地网络由依赖的软件，我不太清楚用 TUN 这类方式会不会对它们造成干扰。<p>不过最近捣鼓 iOS 代理软件让我开始觉得 TUN 这种网络层代理才是更完美的代理方法，所以最终还是把 Windows 也换成了 TUN 代理模式。我目前用的代理软件是 Mihomo Party，内核是 Mihomo。<p>没过几天我就发现 AltStore 刷新软件时找不到 Altserver，Altserver 中也不显示 iOS 设备了。很快我就意识到这很可能是我前几天弄成 TUN 代理导致的。<p>我尝试关闭代理软件，这会删除创建的 TUN 网卡，然后重启 Altserver，但很奇怪的并没有作用。之前我遇到几次 Altserver 连接问题发现通过重启 Apple Mobile Device Service 服务可以修复，然而我尝试了很多次也没有作用。<p>然后我找到了<a target=_blank rel=noopener href=https://github.com/clash-verge-rev/clash-verge-rev/issues/1445>这个 issue</a>，于是尝试关闭代理自启然后重启，此时连接恢复正常。但打开代理软件后，刚开始 AltStore 还可以正常刷新，过一会之后就又连不上了。<h1 id=%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90 tabindex=-1>抓包分析</h1><p>因为 AltServer 通过网络刷新应用需要通过 iTunes 开启 iOS 设备的“通过Wi-Fi 与此设备同步”选项，我知道它的工作原理其实是通过 Bonjour 协议发现设备。猜想是不是 Bonjour 协议在开了 TUN 之后不走物理网卡设备，或者 TUN 向 物理网卡转发导致了问题（我对 TUN 代理的工作原理不太熟悉，所以有很多猜想并不合理）。总之我打算用 Wireshark 抓包看下具体情况。<p>首先要说的是 Apple 的 Bonjour 协议本质上就是 mDNS（Multicast DNS）协议，走 UDP 的5353端口。当 mDNS 客户端需要解析主机名时，它会发送一条 IP 多播查询消息，要求具有该名称的主机识别自己的身份。然后，该目标机器多播一条包含其 IP 地址的消息。<sup class=footnote-ref><a href=#fn1 id=fnref1>[1]</a></sup><p>我先在 Bonjour 正常工作的情况下抓了下包，mDNS 在 IPv4/v6 下面都会工作，但目前我先只看 IPv4 的情况，于是我设置过滤规则 <code>mdns &amp;&amp; ip.addr == 192.168.2.100 || mdns &amp;&amp; ip.addr == 192.168.2.16</code>，<code>192.168.2.100</code> 是电脑的 IP，<code>192.168.2.16</code> 是 iOS 设备的 IP。<p>很快我就发现了目标，一些和 Altserver 有关的 mDNS 查询和回复：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre><td class=code><pre><span class=line>Internet Protocol Version 4, Src: 192.168.2.16, Dst: 224.0.0.251</span><br><span class=line>User Datagram Protocol, Src Port: 5353, Dst Port: 5353</span><br><span class=line>Multicast Domain Name System (query)</span><br><span class=line>    Transaction ID: 0x0000</span><br><span class=line>        [Expert Info (Warning/Protocol): DNS response missing]</span><br><span class=line>    Flags: 0x0000 Standard query</span><br><span class=line>    Questions: 1</span><br><span class=line>    Answer RRs: 0</span><br><span class=line>    Authority RRs: 0</span><br><span class=line>    Additional RRs: 0</span><br><span class=line>    Queries</span><br><span class=line>        MDDPC._altserver._tcp.local: type SRV, class IN, &quot;QU&quot; question</span><br><span class=line>            Name: MDDPC._altserver._tcp.local</span><br><span class=line>            [Name Length: 27]</span><br><span class=line>            [Label Count: 4]</span><br><span class=line>            Type: SRV (33) (Server Selection)</span><br><span class=line>            .000 0000 0000 0001 = Class: IN (0x0001)</span><br><span class=line>            1... .... .... .... = &quot;QU&quot; question: True</span><br><span class=line></span><br><span class=line>Internet Protocol Version 4, Src: 192.168.2.100, Dst: 224.0.0.251</span><br><span class=line>User Datagram Protocol, Src Port: 5353, Dst Port: 5353</span><br><span class=line>Multicast Domain Name System (response)</span><br><span class=line>    Transaction ID: 0x0000</span><br><span class=line>        [Expert Info (Warning/Protocol): DNS response retransmission. Original response in frame 21609]</span><br><span class=line>    Flags: 0x8400 Standard query response, No error</span><br><span class=line>    Questions: 0</span><br><span class=line>    Answer RRs: 1</span><br><span class=line>    Authority RRs: 0</span><br><span class=line>    Additional RRs: 7</span><br><span class=line>    Answers</span><br><span class=line>        MDDPC._altserver._tcp.local: type SRV, class IN, cache flush, priority 0, weight 0, port 1382, target MDDPC.local</span><br><span class=line>    Additional records</span><br><span class=line>        MDDPC.local: type A, class IN, cache flush, addr 192.168.2.100</span><br><span class=line>        MDDPC.local: type AAAA, class IN, cache flush, addr 2001:0db8:85a3:0000:0000:8a2e:0370:7334</span><br><span class=line>        MDDPC.local: type AAAA, class IN, cache flush, addr 2001:0db8:85a3:0000:0000:abcd:ef12:3456</span><br><span class=line>        MDDPC.local: type AAAA, class IN, cache flush, addr 2001:0db8:85a3:0000:1234:5678:9abc:def0</span><br><span class=line>        MDDPC.local: type AAAA, class IN, cache flush, addr fe80::1a2b:3c4d:5e6f:7890</span><br><span class=line>        MDDPC.local: type NSEC, class IN, cache flush, next domain name MDDPC.local</span><br><span class=line>        MDDPC._altserver._tcp.local: type NSEC, class IN, cache flush, next domain name MDDPC._altserver._tcp.local</span><br><span class=line>    [Retransmitted response. Original response in: 21609]</span><br><span class=line>    [Retransmission: True]</span><br></pre></table></figure><p>首先可以看到这两个报文的目的地址都是 <code>224.0.0.251</code>，这是固定的 mDNS 多播 IP 地址。iOS 设备向我的计算机（MDDPC）请求了 <code>_altserver</code> 这一 TCP 服务。而应答中返回了该服务的端口为 1382，通过 <code>MDDPC.local</code> 这一域名访问，同时在 <code>Additional records</code> 中将该域名对应的 IP 均列了出来。这就是 mDNS 大致的工作原理了。<p>接下来我在开启 TUN 的情况下进行抓包，由于此时多了一个 TUN 网卡，所以我分别同时在物理网卡和 TUN 网卡上同时进行抓包。<p>我在 TUN 网卡上确实抓到了一些 mDNS 包，但是没有和 Altserver 有关的包，而且都是计算机自己发送的，没有其他人响应。因为其实 TUN 网卡和物理网卡不在一个网段上，如下，物理网卡网段为 192.168，TAP 网卡为 198.18：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br></pre><td class=code><pre><span class=line>未知适配器 Mihomo:</span><br><span class=line></span><br><span class=line>   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class=line>   描述. . . . . . . . . . . . . . . : Meta Tunnel</span><br><span class=line>   物理地址. . . . . . . . . . . . . : AA-BB-CC-DD-EE-FF</span><br><span class=line>   DHCP 已启用 . . . . . . . . . . . : 否</span><br><span class=line>   自动配置已启用. . . . . . . . . . : 是</span><br><span class=line>   IPv6 地址 . . . . . . . . . . . . : 2001:0db8:abcd::1(首选)</span><br><span class=line>   IPv4 地址 . . . . . . . . . . . . : 198.18.0.1(首选)</span><br><span class=line>   子网掩码  . . . . . . . . . . . . : 255.255.255.252</span><br><span class=line>   默认网关. . . . . . . . . . . . . : ::</span><br><span class=line>                                       0.0.0.0</span><br><span class=line>   DNS 服务器  . . . . . . . . . . . : 2001:0db8:abcd::2</span><br><span class=line>                                       198.18.0.2</span><br><span class=line>   TCPIP 上的 NetBIOS  . . . . . . . : 已启用</span><br><span class=line></span><br><span class=line>以太网适配器 以太网:</span><br><span class=line></span><br><span class=line>   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class=line>   描述. . . . . . . . . . . . . . . : Intel(R) Ethernet Controller I226-V</span><br><span class=line>   物理地址. . . . . . . . . . . . . : 11-22-33-44-55-66</span><br><span class=line>   DHCP 已启用 . . . . . . . . . . . : 否</span><br><span class=line>   自动配置已启用. . . . . . . . . . : 是</span><br><span class=line>   IPv6 地址 . . . . . . . . . . . . : 2001:0db8:abcd::100(首选)</span><br><span class=line>   获得租约的时间  . . . . . . . . . : 2024年9月28日 21:37:00</span><br><span class=line>   租约过期的时间  . . . . . . . . . : 2024年9月30日 6:30:44</span><br><span class=line>   IPv6 地址 . . . . . . . . . . . . : 2001:0db8:abcd::200(首选)</span><br><span class=line>   临时 IPv6 地址. . . . . . . . . . : 2001:0db8:abcd::300(受到抨击)</span><br><span class=line>   临时 IPv6 地址. . . . . . . . . . : 2001:0db8:abcd::400(首选)</span><br><span class=line>   本地链接 IPv6 地址. . . . . . . . : fe80::1a2b:3c4d:5e6f:7890%21(首选)</span><br><span class=line>   IPv4 地址 . . . . . . . . . . . . : 192.168.2.100(首选)</span><br><span class=line>   子网掩码  . . . . . . . . . . . . : 255.255.255.0</span><br><span class=line>   默认网关. . . . . . . . . . . . . : fe80::8ede:f9ff:fead:6d81%21</span><br><span class=line>                                       192.168.2.1</span><br><span class=line>   DHCPv6 IAID . . . . . . . . . . . : 554221496</span><br><span class=line>   DHCPv6 客户端 DUID  . . . . . . . : 00-01-00-01-2C-28-7A-02-11-22-33-44-55-66</span><br><span class=line>   DNS 服务器  . . . . . . . . . . . : 2001:0db8::1</span><br><span class=line>                                       2001:0db8::2</span><br><span class=line>                                       119.29.29.29</span><br><span class=line>                                       223.5.5.5</span><br><span class=line>   TCPIP 上的 NetBIOS  . . . . . . . : 已启用</span><br></pre></table></figure><p>在物理网卡上我抓到了来自 iOS 对 Altserver 的 mDNS 查询请求，但计算机并没有响应。<h1 id=%E8%B0%81%E6%98%AF-bonjour%EF%BC%9F tabindex=-1>谁是 Bonjour？</h1><p>到这里我想看下到底是谁在监听5353端口，通过 <code>netstat -abn</code> 我发现监听 UDP 5353端口的程序不止一个，不太确定 Apple 的 Bonjour 由谁回复：<figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre><td class=code><pre><span class=line> [svchost.exe]</span><br><span class=line>  UDP    0.0.0.0:5353           *:* </span><br><span class=line> [chrome.exe]</span><br><span class=line>  UDP    0.0.0.0:5353           *:*   </span><br><span class=line> [svchost.exe]</span><br><span class=line>  UDP    192.168.2.100:5353     *:*                    </span><br><span class=line> [nvcontainer.exe]</span><br><span class=line>  UDP    192.168.2.100:5353     *:*</span><br><span class=line>...</span><br></pre></table></figure><p>于是我直接打开 Process Hacker 搜索 Bonjour，很快发现了一个叫做 <code>mDNSResponder.exe</code> 的程序，父进程是 <code>services.exe</code> ，他就是 Bonjour 服务。路径是 <code>C:\Program Files\Bonjour\mDNSResponder.exe</code>。<p><img src=https://s2.loli.net/2024/09/29/Hw4MRCloYxhWNjD.png alt="Bonjour 服务"><p>打开 TUN 代理后，我发现 <code>mDNSResponder.exe</code> 很快就退出了。<code>C:\Program Files\Bonjour\</code> 目录下也没有发现有 log。因此我就去系统日志中寻找，于是找到了文章开头的错误日志。<p><img src=https://s2.loli.net/2024/09/29/kjrK9usXtPmbS1v.png alt=错误日志><p>看起来 <code>mDNSResponder.exe</code> 并非正常退出，否则一般也不会触发日志记录，并且是应用程序崩溃事件。这也解释了为什么关闭代理也无法恢复正常：Bonjour 服务并不会自动重启。在我关闭代理并手动启动 Bonjour 服务和 Altserver 后，果然一切恢复了正常。搜了下网上还有其他人也遇到过相同的错误：<a target=_blank rel=noopener href=https://airvpn.org/forums/topic/51827-bonjour-service-crashes-when-eddie-active/ >Bonjour Service Crashes when Eddie Active - Off-Topic - AirVPN</a><p>另外我发现 Clash for Windows 的 TUN 代理并不会导致 Bonjour 服务崩溃，这说明问题很可能并不出在 TUN 本身上。我又尝试更改 TUN 模式的设置，比如设置堆栈，自动全局路由，严格路由，DNS 劫持等等，但不管怎么改 <code>mDNSResponder.exe</code> 都会崩溃。<h1 id=%E9%80%86%E5%90%91%E6%97%B6%E9%97%B4 tabindex=-1>逆向时间</h1><p>为了搞明白问题出在哪里，我准备上 x64dbg 上分析一下。不过 <code>mDNSResponder.exe</code> 默认情况下是以服务程序模式执行的，没办法直接执行：<figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre><td class=code><pre><span class=line><span class=built_in>PS</span> C:\Users\Fusion\Downloads&gt; C:\<span class=string>&#x27;Program Files&#x27;</span>\Bonjour\mDNSResponder.exe</span><br><span class=line><span class=built_in>start</span> service dispatcher failed (<span class=number>1063</span>)</span><br></pre></table></figure><p>不过好在它提供了选项 <code>-server</code> 可以用于直接执行：<figure class="highlight powershell"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre><td class=code><pre><span class=line>mDNSResponder <span class=number>1.0</span>d1</span><br><span class=line></span><br><span class=line>    &lt;no args&gt;    Runs the service normally</span><br><span class=line>    <span class=literal>-install</span>     Creates the service and starts it</span><br><span class=line>    <span class=literal>-remove</span>      Stops the service and deletes it</span><br><span class=line>    <span class=literal>-start</span>       Starts the service dispatcher after processing all other arguments</span><br><span class=line>    <span class=literal>-server</span>      Runs the service directly as a server (<span class=keyword>for</span> debugging)</span><br><span class=line>    <span class=literal>-q</span>           Toggles Quiet Mode (no events or output)</span><br><span class=line>    <span class=literal>-remote</span>      Allow remote connections</span><br><span class=line>    <span class=literal>-cache</span> n     Number of mDNS cache entries (defaults to <span class=number>512</span>)</span><br><span class=line>    <span class=literal>-h</span>[<span class=type>elp</span>]      Display Help/Usage</span><br></pre></table></figure><p>在 x64dbg 中添加参数 <code>-server</code> 后，就可以正常调试了。我发现它启动后很快触发了一个异常：<figure class="highlight plaintext"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre><td class=code><pre><span class=line>EXCEPTION_DEBUG_INFO:  </span><br><span class=line>           dwFirstChance: 1  </span><br><span class=line>           ExceptionCode: C0000005 (EXCEPTION_ACCESS_VIOLATION)  </span><br><span class=line>          ExceptionFlags: 00000000  </span><br><span class=line>        ExceptionAddress: mdnsresponder.[00007FF64BE59D37](x64dbg://localhost/address64#00007FF64BE59D37)  </span><br><span class=line>        NumberParameters: 2  </span><br><span class=line>ExceptionInformation[00]: [0000000000000001](x64dbg://localhost/address64#0000000000000001) Write  </span><br><span class=line>ExceptionInformation[01]: [0000000000150000](x64dbg://localhost/address64#0000000000150000) Inaccessible Address  </span><br><span class=line>第一次异常于 [00007FF64BE59D37](x64dbg://localhost/address64#00007FF64BE59D37) (C0000005, EXCEPTION_ACCESS_VIOLATION)</span><br><span class=line></span><br><span class=line># 出错的指令</span><br><span class=line>00007FF64BE59D37 | 41:8810                 | mov byte ptr ds:[r8],dl                      | r8:&quot;Actx &quot;</span><br></pre></table></figure><p>mov 指令访问了一个不可访问的地址，这个地址就是 r8 寄存器里的 0x150000，mov 试图将 dl 寄存器的内容写到这个地址。<p>这个地址是哪里呢，查看内存布局，可以看到该地址正好位于堆栈上方的只读内存段的开头。结合汇编和在 x64dbg 下的调试，这大概率是一个栈溢出错误。<p><img src=https://s2.loli.net/2024/09/30/hnYrCtyGOU4N6mv.png alt=内存布局><p>于是打开 IDA 开始分析，找到出错位置的伪代码如下：<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line><span class=keyword>if</span> ( <span class=built_in>memcmp</span>(src, sa_family, i-&gt;Address.iSockaddrLength) )</span><br><span class=line>  &#123;</span><br><span class=line>    stack_mem_to_set_ff = <span class=number>0</span>i64;</span><br><span class=line>    v56 = <span class=number>0</span>i64;</span><br><span class=line>    stack_addr = &amp;stack_mem_to_set_ff;</span><br><span class=line>    <span class=keyword>do</span></span><br><span class=line>    &#123;</span><br><span class=line>      <span class=keyword>if</span> ( PrefixLength &lt; <span class=number>8</span> )</span><br><span class=line>        val_ff = <span class=number>-1</span> &lt;&lt; (<span class=number>8</span> - PrefixLength);</span><br><span class=line>      <span class=keyword>else</span></span><br><span class=line>        val_ff = <span class=number>-1</span>;</span><br><span class=line>      *(_BYTE *)stack_addr = val_ff;<span class=comment>// crash here</span></span><br><span class=line>      stack_addr = (__int64 *)((<span class=type>char</span> *)stack_addr + <span class=number>1</span>);</span><br><span class=line>      PrefixLength -= <span class=number>8</span>;</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=keyword>while</span> ( PrefixLength );</span><br></pre></table></figure><p>上面代码已经被我解析过，比较容易能看到问题原因：<code>PrefixLength</code> 在非8的倍数时 while 循环永远不会结束，并且 <code>PrefixLength</code> 是一个 unsigned int，所以会把 <code>stack_mem_to_set_ff</code> 所在栈位置以上内存填充 <code>FF</code>，直到超过栈范围写入只读地址导致崩溃。<p>那么 <code>PrefixLength</code> 又是什么？这就要提到这部分代码开头调用的 <code>GetAdaptersAddresses</code> API了。<figure class="highlight c"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre><td class=code><pre><span class=line>AdaptersAddresses = GetAdaptersAddresses(</span><br><span class=line>                          <span class=number>0</span>,</span><br><span class=line>                          <span class=number>0x3E</span>u,                <span class=comment>// 返回单播地址,返回此适配器上的 IP 地址前缀列表,返回默认网关的地址等</span></span><br><span class=line>                          <span class=number>0</span>i64,                 <span class=comment>// Reserved</span></span><br><span class=line>                          pLinkList_of_IP_ADAPTER_ADDRESSES,</span><br><span class=line>                          &amp;Size);</span><br><span class=line></span><br><span class=line>pFirstPrefix = pLinkList_of_IP_ADAPTER_ADDRESSES_unwind2-&gt;FirstPrefix;</span><br><span class=line></span><br><span class=line>IPHLPAPI_DLL_LINKAGE ULONG <span class="title function_">GetAdaptersAddresses</span><span class=params>(</span></span><br><span class=line><span class=params>  [in]      ULONG                 Family,</span></span><br><span class=line><span class=params>  [in]      ULONG                 Flags,</span></span><br><span class=line><span class=params>  [in]      PVOID                 Reserved,</span></span><br><span class=line><span class=params>  [in, out] PIP_ADAPTER_ADDRESSES AdapterAddresses,</span></span><br><span class=line><span class=params>  [in, out] PULONG                SizePointer</span></span><br><span class=line><span class=params>)</span>;</span><br></pre></table></figure><p>这个函数的定义具体见：<a target=_blank rel=noopener href=https://learn.microsoft.com/en-us/windows/win32/api/iphlpapi/nf-iphlpapi-getadaptersaddresses>GetAdaptersAddresses function (iphlpapi.h) - Win32 apps | Microsoft Learn</a>，简单来说它会返回系统中所有网卡的详细信息。其中 <code>0x3E</code> 为 Flags 参数，其中有一位是 <code>GAA_FLAG_INCLUDE_PREFIX</code>，表示要求系统返回 IPv6 和 IPv4 地址的 IP 地址前缀。所有程序调用这个 API 返回的内容应该是一样的，所以我在 Visual Studio 中写了个测试程序调用该 API 来 debug。<code>PIP_ADAPTER_ADDRESSES-&gt;FirstPrefix</code> 中保存的就是这些前缀了，对于 mihomo TUN 内容如下：<p><img src=https://s2.loli.net/2024/09/30/aDZ98hQgJ6LxS4w.png alt="mihomo TUN 的 FirstPrefix 结构"><p>可以看到所有 Prefix 通过 next 链接在一起，第二层 <code>PrefixLength</code> 为 <code>0x7e</code> 的 Prefix 就是问题所在，它并非8的倍数。<p>另外观察 <code>FirstPrefix-&gt;Address.lpSockaddr-&gt;sa_family</code> 成员，值为 <code>0x2</code> 代表 IPv4，<code>0x17</code> 代表 IPv6。<code>lpSockaddr</code> 这个成员是一个指向 <a target=_blank rel=noopener href=https://learn.microsoft.com/en-us/windows/win32/winsock/sockaddr-2><code>sockaddr</code> 结构体</a>的指针，这个结构体长度根据所选协议不同而有所不同，具体长度储存在 <code>Address.iSockaddrLength</code>中，但第一个成员永远是地址族。<p>网卡 IP 地址储存在 <code>PIP_ADAPTER_ADDRESSES-&gt;FirstUnicastAddress</code> 中，其结构和 Prefix 类似，由于网卡可能有多个 IP 地址，其也有多个 <code>sockaddr</code> 结构，通过链表组织在一起。<p>整体代码的逻辑是遍历所有网卡-&gt;遍历网卡的所有 IP 地址-&gt;遍历网卡所有地址前缀。其作用为找到所有网卡的所有IP对应的子网前缀。出错代码位于遍历网卡所有地址前缀的逻辑内，并且仅在 IP 地址为 IPv6 时才会执行，功能为生成前缀对应的掩码来计算子网前缀。<p>这也就解释了为什么 Clash for Windows 的 TAP 模式不会崩溃，因为即便打开了 IPv6 功能，它的 TAP 网卡依然没有 IPv6 地址，因此就不会执行到错误处。下图为 Clash TAP 的 <code>FirstUnicastAddress</code>，可以看到只有一个 IPv4 类型的地址：<p><img src=https://s2.loli.net/2024/09/30/eOukEG253aK6MNi.png alt="Clash 只有 IPv4 地址"><p>那么如果关闭 mihomo 的 IPv6 功能呢？我测试了一下也不会报错，但查看网卡仍然有 IPv6 地址，此时查看所有 IPv6 Prefix 发现不再有非8倍数的 <code>PrefixLength</code> 了。另外物理网卡自动分配的 Prefix 长度也均为8的倍数。<p>问题的解决方案也很简单，只要将生成掩码的循环的判断条件从不为0修改为大于0即可。对应到汇编代码即将下图的 <code>jne</code> 指令修改为 <code>jg</code>，对应到程序文件就是将 <code>0x9140</code> 偏移处的 <code>75</code> 修改为 <code>7F</code>。<p><img src=https://s2.loli.net/2024/09/30/Zuex8yAXFPf7js6.png alt=崩溃处汇编指令><p><img src=https://s2.loli.net/2024/09/30/ILtHKNnBpeDOgT8.png alt=修补文件对比><h1 id=%E5%90%8E%E8%AF%9D tabindex=-1>后话</h1><p>修好这个问题后我又去找了下，Bonjour 的源码其实已经被 Apple 公开了，感兴趣的可以去看下：<p><a target=_blank rel=noopener href=https://github.com/apple-oss-distributions/mDNSResponder/tree/main/mDNSWindows>mDNSResponder/mDNSWindows at main · apple-oss-distributions/mDNSResponder · GitHub</a><p>本篇文章分析的代码对应的是 mDNSWin32.c 中的 <code>getifaddrs_ipv6</code>。该库中最新代码已经修复了这个问题。然而我并不知道这个修复的版本被用在了哪里，Bonjour 本身似乎并没有独立的安装包，我系统中的 Bonjour 是安装非 Windows 商店版本的 iTunes 时自带的（因为 Altserver 不支持商店版 iTunes）。也许是用在了现在商店版本的“Apple 设备”这个软件中？<p>另外，我还尝试构建了下这个最新的开源版本，很不幸并没有构建成功。如果可以的话还想试下用最新版本的 Bonjour 替换下，现在这个版本修改日期还是15年的，算下来都快10年了（天呐）。<p>那么就到这里吧，这些工作都是我一晚上肝出来的，说实话开始时没想到会走到通过逆向把它修好这步，感觉学到很多。<h1 id=%E5%8F%82%E8%80%83 tabindex=-1>参考</h1><hr class=footnotes-sep><section class=footnotes><ol class=footnotes-list><li id=fn1 class=footnote-item><p><a target=_blank rel=noopener href=https://en.wikipedia.org/wiki/Multicast_DNS>Multicast DNS - Wikipedia</a> <a href=#fnref1 class=footnote-backref>↩︎</a></ol></section></div><div class="article-licensing box"><div class=licensing-title><p>Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug<p><a href=https://universesaurora.top/2024/09/29/bonjour_fix/ >https://universesaurora.top/2024/09/29/bonjour_fix/</a></div><div class="licensing-meta level is-mobile"><div class=level-left><div class="level-item is-narrow"><div><h6>作者</h6><p>浮枕</div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-09-30</div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-09-30</div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a rel=noopener target=_blank title="CC BY-NC-SA 4.0" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a><a class=icons rel=noopener target=_blank title="Creative Commons" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ ><i class="icon fab fa-creative-commons"></i></a><a class=icons rel=noopener target=_blank title="CC BY" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ ><i class="icon fab fa-creative-commons-by"></i></a><a class=icons rel=noopener target=_blank title="CC NC" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ ><i class="icon fab fa-creative-commons-nc"></i></a><a class=icons rel=noopener target=_blank title="CC SA" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ ><i class="icon fab fa-creative-commons-sa"></i></a></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class=mr-2>#</span><a class="link-muted mr-2" rel=tag href=/tags/%E7%BD%91%E7%BB%9C/ >网络</a><a class="link-muted mr-2" rel=tag href=/tags/%E9%80%86%E5%90%91/ >逆向</a><a class="link-muted mr-2" rel=tag href=/tags/%E4%BB%A3%E7%90%86/ >代理</a><a class="link-muted mr-2" rel=tag href=/tags/Bonjour/ >Bonjour</a></div><div class=sharethis-inline-share-buttons></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=6291b3ba6ad7c40019490138&amp;product=sop" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class=level-end><a class="article-nav-next level level-item link-muted" href=/2024/05/18/initramfs_boot_fail/ ><span class=level-item>一次 Linux 5.4 内核启动失败分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class=card><div class=card-content><h3 class="title is-5">评论</h3><div id=comment-container></div><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.css><script src=https://cdn.bootcdn.net/ajax/libs/gitalk/1.7.2/gitalk.min.js></script><script>var gitalk=new Gitalk({id:"868220155cb9a0aca1cab634bcb39424",repo:"universesaurora-blog",owner:"UniversesAurora",clientID:"0d93b8fa7142b6c21de0",clientSecret:"fd1449c0798a980110bd15b1a5e35ea3d590d9aa",admin:["UniversesAurora"],createIssueManually:!1,distractionFreeMode:!1,perPage:20,pagerDirection:"last",enableHotKey:!0,language:"zh-CN"});gitalk.render("comment-container")</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen order-1"><div class="card widget" data-type=profile><div class=card-content><nav class=level><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src=/img/avatar.png alt=浮枕></figure><p class="title is-size-4 is-block" style=line-height:inherit>浮枕<p class="is-size-6 is-block">Kernel panic at 0xffff467573696f6e<p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中央図書館断絶の壁分室</span></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class=heading>文章</p><a href=/archives><p class=title>8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class=heading>分类</p><a href=/categories><p class=title>5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class=heading>标签</p><a href=/tags><p class=title>16</p></a></div></div></nav><div class=level><a class="level-item button is-primary is-rounded" href=https://twitter.com/universesaurora target=_blank rel=noopener>关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=Telegram href=https://t.me/universesaurora><i class="fab fa-telegram"></i></a><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=Mastodon href=https://mastodon.social/@universesaurora><i class="fab fa-mastodon"></i></a><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=Twitter href=https://twitter.com/universesaurora><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=Github href=https://github.com/UniversesAurora><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=Email href=mailto:universesaurora@gmail.com><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target=_blank rel=noopener title=RSS href=/atom.xml><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type=categories><div class=card-content><div class=menu><h3 class=menu-label>分类</h3><ul class=menu-list><li><a class="level is-mobile" href=/categories/%E5%86%85%E6%A0%B8/ ><span class=level-start><span class=level-item>内核</span></span><span class=level-end><span class="level-item tag">3</span></span></a><li><a class="level is-mobile" href=/categories/%E6%9D%82%E8%B0%88/ ><span class=level-start><span class=level-item>杂谈</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/categories/%E7%A1%AC%E4%BB%B6/ ><span class=level-start><span class=level-item>硬件</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/categories/%E9%80%86%E5%90%91/ ><span class=level-start><span class=level-item>逆向</span></span><span class=level-end><span class="level-item tag">2</span></span></a><li><a class="level is-mobile" href=/categories/%E9%9A%8F%E7%AC%94/ ><span class=level-start><span class=level-item>随笔</span></span><span class=level-end><span class="level-item tag">1</span></span></a></ul></div></div></div><div class="card widget" data-type=tags><div class=card-content><div class=menu><h3 class=menu-label>标签</h3><div class="field is-grouped is-grouped-multiline"><div class=control><a class="tags has-addons" href=/tags/Bonjour/ ><span class=tag>Bonjour</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/Linux/ ><span class=tag>Linux</span><span class=tag>2</span></a></div><div class=control><a class="tags has-addons" href=/tags/clangd/ ><span class=tag>clangd</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/initramfs/ ><span class=tag>initramfs</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/llvm/ ><span class=tag>llvm</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/nvdimm/ ><span class=tag>nvdimm</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/sk-buff/ ><span class=tag>sk_buff</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/vscode/ ><span class=tag>vscode</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E4%BB%A3%E7%90%86/ ><span class=tag>代理</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E5%86%85%E6%A0%B8/ ><span class=tag>内核</span><span class=tag>3</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E6%B8%B8%E6%88%8F/ ><span class=tag>游戏</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E7%A1%AC%E4%BB%B6/ ><span class=tag>硬件</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E7%BD%91%E7%BB%9C/ ><span class=tag>网络</span><span class=tag>2</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E8%B0%83%E5%BA%A6%E5%99%A8/ ><span class=tag>调度器</span><span class=tag>1</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E9%80%86%E5%90%91/ ><span class=tag>逆向</span><span class=tag>2</span></a></div><div class=control><a class="tags has-addons" href=/tags/%E9%9A%8F%E7%AC%94/ ><span class=tag>随笔</span><span class=tag>1</span></a></div></div></div></div></div><div class="card widget" data-type=archives><div class=card-content><div class=menu><h3 class=menu-label>归档</h3><ul class=menu-list><li><a class="level is-mobile" href=/archives/2024/09/ ><span class=level-start><span class=level-item>九月 2024</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/archives/2024/05/ ><span class=level-start><span class=level-item>五月 2024</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/archives/2023/05/ ><span class=level-start><span class=level-item>五月 2023</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/archives/2023/04/ ><span class=level-start><span class=level-item>四月 2023</span></span><span class=level-end><span class="level-item tag">2</span></span></a><li><a class="level is-mobile" href=/archives/2022/07/ ><span class=level-start><span class=level-item>七月 2022</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/archives/2022/06/ ><span class=level-start><span class=level-item>六月 2022</span></span><span class=level-end><span class="level-item tag">1</span></span></a><li><a class="level is-mobile" href=/archives/2022/05/ ><span class=level-start><span class=level-item>五月 2022</span></span><span class=level-end><span class="level-item tag">1</span></span></a></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id=toc data-type=toc><div class=card-content><div class=menu><h3 class=menu-label>目录</h3><ul class=menu-list><li><a class="level is-mobile" href=#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF><span class=level-left><span class=level-item>1</span><span class=level-item>问题背景</span></span></a><li><a class="level is-mobile" href=#%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90><span class=level-left><span class=level-item>2</span><span class=level-item>抓包分析</span></span></a><li><a class="level is-mobile" href=#%E8%B0%81%E6%98%AF-bonjour%EF%BC%9F><span class=level-left><span class=level-item>3</span><span class=level-item>谁是 Bonjour？</span></span></a><li><a class="level is-mobile" href=#%E9%80%86%E5%90%91%E6%97%B6%E9%97%B4><span class=level-left><span class=level-item>4</span><span class=level-item>逆向时间</span></span></a><li><a class="level is-mobile" href=#%E5%90%8E%E8%AF%9D><span class=level-left><span class=level-item>5</span><span class=level-item>后话</span></span></a><li><a class="level is-mobile" href=#%E5%8F%82%E8%80%83><span class=level-left><span class=level-item>6</span><span class=level-item>参考</span></span></a></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src=/js/toc.js defer></script></div><div class="card widget" data-type=recent-posts><div class=card-content><h3 class=menu-label>最新文章</h3><article class=media><figure class=media-left><a class=image href=/2024/09/29/bonjour_fix/ ><img src=https://cdn.pixabay.com/photo/2023/08/08/21/25/france-8178164_1280.jpg alt="Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug"></a></figure><div class=media-content><p class=date><time datetime=2024-09-29T23:15:16.000Z>2024-09-30</time><p class=title><a href=/2024/09/29/bonjour_fix/ >Bonjour 不 Bon：修复 Bonjour 中存在的 IPv6 栈溢出 bug</a><p class=categories><a href=/categories/%E9%80%86%E5%90%91/ >逆向</a></div></article><article class=media><figure class=media-left><a class=image href=/2024/05/18/initramfs_boot_fail/ ><img src=https://cdn.pixabay.com/photo/2023/12/29/15/37/balloons-8476432_1280.jpg alt="一次 Linux 5.4 内核启动失败分析"></a></figure><div class=media-content><p class=date><time datetime=2024-05-18T15:25:38.000Z>2024-05-18</time><p class=title><a href=/2024/05/18/initramfs_boot_fail/ >一次 Linux 5.4 内核启动失败分析</a><p class=categories><a href=/categories/%E5%86%85%E6%A0%B8/ >内核</a></div></article><article class=media><figure class=media-left><a class=image href=/2023/05/19/clangd_vsc_fault/ ><img src=https://cdn.pixabay.com/photo/2023/05/15/15/33/landscape-7995369_1280.jpg alt="Apple Clangd 掉坑记"></a></figure><div class=media-content><p class=date><time datetime=2023-05-19T07:51:21.000Z>2023-05-19</time><p class=title><a href=/2023/05/19/clangd_vsc_fault/ >Apple Clangd 掉坑记</a><p class=categories><a href=/categories/%E6%9D%82%E8%B0%88/ >杂谈</a></div></article><article class=media><figure class=media-left><a class=image href=/2023/04/21/skbuff_repost/ ><img src=https://cdn.pixabay.com/photo/2018/10/19/12/14/train-3758523_1280.jpg alt="Linux 内核网络中的 sk_buff 数据结构"></a></figure><div class=media-content><p class=date><time datetime=2023-04-21T02:22:53.000Z>2023-04-21</time><p class=title><a href=/2023/04/21/skbuff_repost/ >Linux 内核网络中的 sk_buff 数据结构</a><p class=categories><a href=/categories/%E5%86%85%E6%A0%B8/ >内核</a></div></article><article class=media><figure class=media-left><a class=image href=/2023/04/20/cfs_weight_nice/ ><img src=https://cdn.pixabay.com/photo/2016/08/26/12/44/houses-1622066_1280.jpg alt=CFS调度器、权重、优先级与虚拟时钟></a></figure><div class=media-content><p class=date><time datetime=2023-04-20T13:47:32.000Z>2023-04-20</time><p class=title><a href=/2023/04/20/cfs_weight_nice/ >CFS调度器、权重、优先级与虚拟时钟</a><p class=categories><a href=/categories/%E5%86%85%E6%A0%B8/ >内核</a></div></article></div></div><div class="card widget" data-type=subscribe-email><div class=card-content><div class=menu><h3 class=menu-label>follow.it</h3><form action="https://api.follow.it/subscription-form/a1BGa2tQbURTbStQandqbGNOeWgzcytQME9iVityYVNVaVVGR2N5NzlGZDFaWDlHYnRLc0hmczZrVDFOY3dzamVYTDFIdGZxOVgvNTJwRm5RNjlqVVN5RzBNK0M1RVBUOEhlZXUwOEtyWG8vRVhPRUR4RFZFeUdwbTArSE0vdmF8dkswd0lGYUxxRGM0RHpnd280RDBtT3JXenNZQ2N6RG5oeVNjMjVTNitlcz0=/8" method=post target=_blank><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class=input name=email type=email placeholder=Email><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class=control><input class=button type=submit value=订阅></div></div></form></div></div></div><div class="card widget" data-type=links><div class=card-content><div class=menu><h3 class=menu-label>链接</h3><ul class=menu-list><li><a class="level is-mobile" href=https://MoeClue.com/ target=_blank rel=noopener><span class=level-left><span class=level-item>Moeka</span></span><span class=level-right><span class="level-item tag">moeclue.com</span></span></a><li><a class="level is-mobile" href=https://mou.best target=_blank rel=noopener><span class=level-left><span class=level-item>小莫のBase</span></span><span class=level-right><span class="level-item tag">mou.best</span></span></a></ul></div></div></div></div></div></div></section><footer class=footer><div class=container><div class=level><div class=level-start><a class="footer-logo is-block mb-2" href=/ ><img src=/img/logo.png alt=浮枕星海 height=28></a><p class=is-size-7><span>&copy; 2024 浮枕</span>  Powered by <a href=https://hexo.io/ target=_blank rel=noopener>Hexo</a> &amp; <a href=https://github.com/ppoffice/hexo-theme-icarus target=_blank rel=noopener>Icarus</a><br><span id=busuanzi_container_site_uv>共<span id=busuanzi_value_site_uv>0</span>个访客</span><p class=is-size-7>世界は、あなたのスキで目覚め、変わってゆくものなのですから...</div><div class=level-end><div class="field has-addons"><p class=control><a class="button is-transparent" target=_blank rel=noopener title="CC BY-NC-SA 4.0" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a><p class=control><a class="button is-transparent is-large" target=_blank rel=noopener title="CC BY-NC-SA 4.0 icons" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ ><i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> <i class="fab fa-creative-commons-nc"></i> <i class="fab fa-creative-commons-sa"></i> </a></div></div></div></div></footer><script src=https://cdn.bootcdn.net/ajax/libs/jquery/3.3.1/jquery.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js defer></script><script>moment.locale("zh-cn")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script src=/js/column.js></script><script src=/js/animation.js></script><a id=back-to-top title=回到顶端 href=javascript:;><i class="fas fa-chevron-up"></i></a><script src=/js/back_to_top.js defer></script><!--!--><!--!--><!--!--><!--!--><script src=https://cdn.bootcdn.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js defer></script><script>window.addEventListener("load",(()=>{window.cookieconsent.initialise({type:"info",theme:"edgeless",static:!1,position:"bottom-right",content:{message:"此网站使用Cookie来改善您的体验。",dismiss:"知道了！",allow:"允许使用Cookie",deny:"拒绝",link:"了解更多",policy:"Cookie政策",href:"https://www.cookiesandyou.com/"},palette:{popup:{background:"#edeff5",text:"#838391"},button:{background:"#4b81e8"}}})}))</script><script src=https://cdn.bootcdn.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js defer></script><script src=https://cdn.bootcdn.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js defer></script><script>window.addEventListener("load",(()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())}))</script><!--!--><!--!--><script id=MathJax-script async>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"},chtml:{matchFontHeight:!1}}</script><script src=https://cdn.bootcdn.net/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js></script><div id=outdated><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id=btnUpdateBrowser target=_blank rel=noopener href=http://outdatedbrowser.com/ >Update my browser now</a><p class=last><a href=# id=btnCloseUpdateBrowser title=Close>×</a></div><script src=https://cdn.bootcdn.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js defer></script><script>window.addEventListener("load",(function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"object-fit"})}))</script><!--!--><!--!--><!--!--><script src=/js/main.js defer></script><div class=searchbox><div class=searchbox-container><div class=searchbox-header><div class=searchbox-input-container><input class=searchbox-input placeholder=想要查找什么...></div><a class=searchbox-close href=javascript:;>×</a></div><div class=searchbox-body></div></div></div><script src=/js/insight.js defer></script><script>document.addEventListener("DOMContentLoaded",(function(){loadInsight({contentUrl:"/content.json"},{hint:"想要查找什么...",untitled:"(无标题)",posts:"文章",pages:"页面",categories:"分类",tags:"标签"})}))</script>
