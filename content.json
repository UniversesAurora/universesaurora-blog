{"pages":[{"title":"","text":"","link":"/404.html"},{"title":"关于","text":"关于我 浮枕，之前用过很长一段时间的名字是 Miguel Duarte，现在主要作为网上的英文名。换成现在这个名字的主要是因为想有一个好记的中文网名，灵感来自于英文 fusion，改成了和它发音相似又给我感觉比较好听的中文。 主业和兴趣都是计算机相关，对内核与体系结构比较感兴趣。大部分时间都在写 C。 很少看动画，但是很喜欢幾原邦彥。 许可 本站 logo 和 404 页面图片来源于 freepik，并经过修改。 Planet vector created by pikisuperstar - www.freepik.com 404 vector created by freepik - www.freepik.com","link":"/about.html"},{"title":"友链","text":"Moeka","link":"/links.html"}],"posts":[{"title":"小探 GI global-metadata","text":"算是博客的第一篇正式文章。 最近尝试了一下原神私服，在弄模型替换的时候出了点问题，正好借此机会对游戏做一点探索。 起因 想要在游戏中进行模型替换需要一个叫做 Melonloader 的框架，但这个框架在 2.7 版本中无法使用了[1]。查看产生的 log 可以发现该问题出在 Il2CppDumper 上： 1234567891011121314151617...[20:57:40.389] Executing Il2CppDumper...[20:57:40.392] &quot;C:\\Users\\Miguel\\Downloads\\GrassCutPer\\Genshin Impact\\Genshin Impact Game\\MelonLoader\\Dependencies\\Il2CppAssemblyGenerator\\Il2CppDumper\\Il2CppDumper.exe&quot; &quot;C:\\Users\\Miguel\\Downloads\\GrassCutPer\\Genshin Impact\\Genshin Impact Game\\YuanShen_Data\\Native\\UserAssembly.dll&quot; &quot;C:\\Users\\Miguel\\Downloads\\GrassCutPer\\Genshin Impact\\Genshin Impact Game\\YuanShen_Data\\Native\\Data\\Metadata\\global-metadata.dat&quot;[20:57:40.766] Initializing metadata...[20:57:46.401] System.InvalidOperationException: 序列不包含任何元素[20:57:46.401] 在 System.Linq.Enumerable.Max[TSource](IEnumerable`1 source)[20:57:46.402] 在 Il2CppDumper.Metadata.&lt;&gt;c.&lt;ProcessingMetadataUsage&gt;b__38_0(KeyValuePair`2 x)[20:57:46.403] 在 System.Linq.Enumerable.WhereSelectEnumerableIterator`2.MoveNext()[20:57:46.404] 在 System.Linq.Enumerable.Max[TSource](IEnumerable`1 source)[20:57:46.405] 在 Il2CppDumper.Metadata.ProcessingMetadataUsage()[20:57:46.406] 在 Il2CppDumper.Metadata..ctor(Stream stream, StringDecryptionData decData, String nameTranslationPath)[20:57:46.407] 在 Il2CppDumper.Program.Init(String il2cppPath, String metadataPath, String nameTranslationPath, Metadata&amp; metadata, Il2Cpp&amp; il2Cpp)[20:57:46.408] 在 Il2CppDumper.Program.Main(String[] args)[20:57:46.419] Executing Il2CppAssemblyUnhollower......[20:57:46.516] [ERROR] 未经处理的异常: System.IO.DirectoryNotFoundException: 未能找到路径“C:\\Users\\Miguel\\Downloads\\GrassCutPer\\Genshin Impact\\Genshin Impact Game\\MelonLoader\\Dependencies\\Il2CppAssemblyGenerator\\Il2CppDumper\\DummyDll”的一部分。... 经过一番搜索后，我发现这个 Il2CppDumper 实际上是被修改过的，原本的 Il2CppDumper 只能解析出 unity 正常生成的 global-metadata.dat，但游戏将 global-metadata.dat 文件进行了一些混淆，所以不将其解密是无法成功将元数据导出来的。Il2CppDumper 大概的作用就是把经过 Il2Cpp 转换后需要用到的符号还原出来并生成一系列 dll 文件，而 Melonloader 的运行应该需要用到这些 dll 文件。 这样看来应该是 2.7 版本的混淆方法有了变化，导致这个针对之前设计的 Il2CppDumper 没法正确解密了。虽然静等作者更新这个程序也不是不行，但刚好我之前有过探索下这个游戏背后的程序结构之类的想法，于是就打算自己分析分析看看能不能把这个解密方法修复下。 行为 用二进制编辑器看了下 metadata 文件，头部的标志已经没有了，和之前版本的对比了下也没看出来什么门道。我首先想到的是抓抓系统调用看看打开 metadata 文件的前后发生了些啥，然而抓了后又把 map/read 之类操作和 metadata 文件对了下，依然看不出什么东西，显然这种简单的分析是完全没用的。更诡异的是运行几次后连 read 都抓不到了，难不成这东西还有缓存的？ UserAssembly.dll 于是把 UserAssembly.dll 丢进 ida 分析了下。 一测的metadata有mark已经不一样了找到异常抛出点回溯一下，header.metadataUsageListsCount为0，发现还是DecryptMetadataBlocks有问题，头部读出的信息错误 DecryptMetadataBlocks开头的几个判断条件都是对的啊，看起来文件可能只被微调了以异或为主要逻辑加一点偏移上调试看看原神怎么算的 忘记了原神有壳 没法动态调试了 不熟 1private_server_launch.cmd 127.0.0.1 443 true &quot;&lt;YuanShen.exe 路径&gt;&quot; &quot;&lt;GrassClipper 路径&gt;&quot; false true 该问题的 Github Issue ↩︎","link":"/2022/06/10/gi_research_metadata/"},{"title":"序","text":"总之是本博客的第一篇文章。 大概是我建的第三个博客了，之前的几个因为各种原因现在连记录都已经没有了。第一个博客是大概 18 年 5 月，我在自己的主机上用 Wordpress 搭建的。和现在这个不同，当时用的是 .com 域名。但是之前实际上也没写什么东西出来，唯一一个比较可惜的是写过一篇关于 Windows 驱动的文章，现在也没有备份了。 之所以又建了这个博客是因为最近又觉得自己应该有一个能写些东西的地方，在已有的平台上写总感觉有些拘束，不如自己建一个更自由些。 这个博客是用 Hexo 搭建的，托管在 github 上，相对方便一些。 之后应该不会再把博客删掉了。","link":"/2022/05/28/preface/"}],"tags":[{"name":"逆向","slug":"逆向","link":"/tags/%E9%80%86%E5%90%91/"},{"name":"游戏","slug":"游戏","link":"/tags/%E6%B8%B8%E6%88%8F/"},{"name":"随笔","slug":"随笔","link":"/tags/%E9%9A%8F%E7%AC%94/"}],"categories":[{"name":"逆向","slug":"逆向","link":"/categories/%E9%80%86%E5%90%91/"},{"name":"随笔","slug":"随笔","link":"/categories/%E9%9A%8F%E7%AC%94/"}]}