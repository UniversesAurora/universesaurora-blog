<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>浮枕星海</title>
  
  <subtitle>浮枕 blog</subtitle>
  <link href="https://universesaurora.top/atom.xml" rel="self"/>
  
  <link href="https://universesaurora.top/"/>
  <updated>2022-06-10T12:07:46.000Z</updated>
  <id>https://universesaurora.top/</id>
  
  <author>
    <name>浮枕</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>小探 GI global-metadata</title>
    <link href="https://universesaurora.top/2022/06/10/gi_research_metadata/"/>
    <id>https://universesaurora.top/2022/06/10/gi_research_metadata/</id>
    <published>2022-06-10T12:07:34.000Z</published>
    <updated>2022-06-10T12:07:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>算是博客的第一篇正式文章。</p><p>最近尝试了一下原神私服，在弄模型替换的时候出了点问题，正好借此机会对游戏做一点探索。</p><span id="more"></span><h2 id="%E8%B5%B7%E5%9B%A0" tabindex="-1" id="起因">起因</h2><p>想要在游戏中进行模型替换需要一个叫做 Melonloader 的框架，但这个框架在 2.7 版本中无法使用了<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。查看产生的 log 可以发现该问题出在 Il2CppDumper 上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[20:57:40.389] Executing Il2CppDumper...</span><br><span class="line">[20:57:40.392] &quot;C:\Users\Miguel\Downloads\GrassCutPer\Genshin Impact\Genshin Impact Game\MelonLoader\Dependencies\Il2CppAssemblyGenerator\Il2CppDumper\Il2CppDumper.exe&quot; &quot;C:\Users\Miguel\Downloads\GrassCutPer\Genshin Impact\Genshin Impact Game\YuanShen_Data\Native\UserAssembly.dll&quot; &quot;C:\Users\Miguel\Downloads\GrassCutPer\Genshin Impact\Genshin Impact Game\YuanShen_Data\Native\Data\Metadata\global-metadata.dat&quot;</span><br><span class="line">[20:57:40.766] Initializing metadata...</span><br><span class="line">[20:57:46.401] System.InvalidOperationException: 序列不包含任何元素</span><br><span class="line">[20:57:46.401]    在 System.Linq.Enumerable.Max[TSource](IEnumerable`1 source)</span><br><span class="line">[20:57:46.402]    在 Il2CppDumper.Metadata.&lt;&gt;c.&lt;ProcessingMetadataUsage&gt;b__38_0(KeyValuePair`2 x)</span><br><span class="line">[20:57:46.403]    在 System.Linq.Enumerable.WhereSelectEnumerableIterator`2.MoveNext()</span><br><span class="line">[20:57:46.404]    在 System.Linq.Enumerable.Max[TSource](IEnumerable`1 source)</span><br><span class="line">[20:57:46.405]    在 Il2CppDumper.Metadata.ProcessingMetadataUsage()</span><br><span class="line">[20:57:46.406]    在 Il2CppDumper.Metadata..ctor(Stream stream, StringDecryptionData decData, String nameTranslationPath)</span><br><span class="line">[20:57:46.407]    在 Il2CppDumper.Program.Init(String il2cppPath, String metadataPath, String nameTranslationPath, Metadata&amp; metadata, Il2Cpp&amp; il2Cpp)</span><br><span class="line">[20:57:46.408]    在 Il2CppDumper.Program.Main(String[] args)</span><br><span class="line">[20:57:46.419] Executing Il2CppAssemblyUnhollower...</span><br><span class="line">...</span><br><span class="line">[20:57:46.516] [ERROR] 未经处理的异常:  System.IO.DirectoryNotFoundException: 未能找到路径“C:\Users\Miguel\Downloads\GrassCutPer\Genshin Impact\Genshin Impact Game\MelonLoader\Dependencies\Il2CppAssemblyGenerator\Il2CppDumper\DummyDll”的一部分。</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>经过一番搜索后，我发现这个 Il2CppDumper 实际上是被修改过的，原本的 Il2CppDumper 只能解析出 unity 正常生成的 global-metadata.dat，但游戏将 global-metadata.dat 文件进行了一些混淆，所以不将其解密是无法成功将元数据导出来的。Il2CppDumper 大概的作用就是把经过 Il2Cpp 转换后需要用到的符号还原出来并生成一系列 dll 文件，而 Melonloader 的运行应该需要用到这些 dll 文件。</p><p>这样看来应该是 2.7 版本的混淆方法有了变化，导致这个针对之前设计的 Il2CppDumper 没法正确解密了。虽然静等作者更新这个程序也不是不行，但刚好我之前有过探索下这个游戏背后的程序结构之类的想法，于是就打算自己分析分析看看能不能把这个解密方法修复下。</p><h2 id="%E8%A1%8C%E4%B8%BA" tabindex="-1" id="行为">行为</h2><p>用二进制编辑器看了下 metadata 文件，头部的标志已经没有了，和之前版本的对比了下也没看出来什么门道。我首先想到的是抓抓系统调用看看打开 metadata 文件的前后发生了些啥，然而抓了后又把 map/read 之类操作和 metadata 文件对了下，依然看不出什么东西，显然这种简单的分析是完全没用的。更诡异的是运行几次后连 read 都抓不到了，难不成这东西还有缓存的？</p><p><img src="https://s2.loli.net/2022/06/10/VgBNwJjQX9mWU82.png" alt="Process Monitor 记录"></p><h2 id="userassembly.dll" tabindex="-1" id="UserAssembly-dll">UserAssembly.dll</h2><p>于是把 UserAssembly.dll 丢进 ida 分析了下。</p><p>一测的metadata有mark已经不一样了找到异常抛出点回溯一下，header.metadataUsageListsCount为0，发现还是DecryptMetadataBlocks有问题，头部读出的信息错误<br>DecryptMetadataBlocks开头的几个判断条件都是对的啊，看起来文件可能只被微调了以异或为主要逻辑加一点偏移上调试看看原神怎么算的 忘记了原神有壳 没法动态调试了 不熟</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private_server_launch.cmd 127.0.0.1 443 <span class="literal">true</span> <span class="string">&quot;&lt;YuanShen.exe 路径&gt;&quot;</span> <span class="string">&quot;&lt;GrassClipper 路径&gt;&quot;</span> <span class="literal">false</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p><a href="https://github.com/lassedds/Melonloader-AnimeGaming/issues/3">该问题的 Github Issue</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section>]]></content>
    
    
    <summary type="html">&lt;p&gt;算是博客的第一篇正式文章。&lt;/p&gt;
&lt;p&gt;最近尝试了一下原神私服，在弄模型替换的时候出了点问题，正好借此机会对游戏做一点探索。&lt;/p&gt;</summary>
    
    
    
    <category term="逆向" scheme="https://universesaurora.top/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="逆向" scheme="https://universesaurora.top/tags/%E9%80%86%E5%90%91/"/>
    
    <category term="游戏" scheme="https://universesaurora.top/tags/%E6%B8%B8%E6%88%8F/"/>
    
  </entry>
  
  <entry>
    <title>序</title>
    <link href="https://universesaurora.top/2022/05/28/preface/"/>
    <id>https://universesaurora.top/2022/05/28/preface/</id>
    <published>2022-05-28T16:05:54.000Z</published>
    <updated>2022-05-29T03:22:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>总之是本博客的第一篇文章。</p><span id="more"></span><p>大概是我建的第三个博客了，之前的几个因为各种原因现在连记录都已经没有了。第一个博客是大概 18 年 5 月，我在自己的主机上用 Wordpress 搭建的。和现在这个不同，当时用的是 .com 域名。但是之前实际上也没写什么东西出来，唯一一个比较可惜的是写过一篇关于 Windows 驱动的文章，现在也没有备份了。</p><p>之所以又建了这个博客是因为最近又觉得自己应该有一个能写些东西的地方，在已有的平台上写总感觉有些拘束，不如自己建一个更自由些。</p><p>这个博客是用 <a href="https://hexo.io/zh-cn/">Hexo</a> 搭建的，托管在 <a href="https://github.com/UniversesAurora/universesaurora-blog">github</a> 上，相对方便一些。</p><p>之后应该不会再把博客删掉了。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;总之是本博客的第一篇文章。&lt;/p&gt;</summary>
    
    
    
    <category term="随笔" scheme="https://universesaurora.top/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
    <category term="随笔" scheme="https://universesaurora.top/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
</feed>
